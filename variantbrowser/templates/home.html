{% extends "base.html" %}
{% block title %}Home · Variant Browser{% endblock %}
{% block page_content %}
<section class="text-center py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <h1 class="display-5 fw-semibold mb-3">Data-driven penetrance insights for inherited arrhythmia genes</h1>
            <p class="lead text-muted">Explore curated clinical, structural, and functional evidence for <i>KCNQ1</i>,
                <i>KCNH2</i>, <i>SCN5A</i>, and <i>RYR2</i> variants. Filter interactive tables, view graphical summaries,
                and download data to support research and clinical decision making.</p>
            <!-- Quick Search -->
            <div class="mt-4 mb-3">
                <div class="row justify-content-center">
                    <div class="col-lg-8 col-xl-6">
                        <div class="input-group input-group-lg shadow-sm">
                            <span class="input-group-text bg-white border-end-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-muted" viewBox="0 0 16 16">
                                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                </svg>
                            </span>
                            <input type="text" id="variantSearch" class="form-control border-start-0" 
                                   placeholder="Search any variant: R534C, p.Ala561Val, c.1600G>A..." 
                                   autocomplete="off">
                        </div>
                        <div id="searchResults" class="position-relative">
                            <div id="searchDropdown" class="position-absolute w-100 bg-white border rounded-3 shadow-lg mt-1 d-none" style="z-index: 1000; max-height: 400px; overflow-y: auto;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
                <a class="btn btn-primary" href="#get-started">Get started</a>
                <a class="btn btn-outline-secondary" href="{% url 'about' %}">Learn more about the project</a>
            </div>
        </div>
    </div>
</section>

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('variantSearch');
    const searchDropdown = document.getElementById('searchDropdown');
    let debounceTimer;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();
        
        if (query.length < 2) {
            searchDropdown.classList.add('d-none');
            return;
        }
        
        debounceTimer = setTimeout(function() {
            fetch('/api/search/?q=' + encodeURIComponent(query))
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        let html = '<div class="list-group list-group-flush">';
                        data.results.forEach(function(r) {
                            const penBadge = r.penetrance !== null 
                                ? '<span class="badge ' + getPenetranceBadge(r.penetrance) + ' ms-2">' + r.penetrance + '%</span>'
                                : '';
                            html += '<a href="' + r.url + '" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">' +
                                '<div><span class="badge bg-secondary me-2">' + r.gene + '</span><strong>' + r.variant + '</strong></div>' +
                                '<div>' + penBadge + '</div>' +
                                '</a>';
                        });
                        html += '</div>';
                        searchDropdown.innerHTML = html;
                        searchDropdown.classList.remove('d-none');
                    } else {
                        searchDropdown.innerHTML = '<div class="p-3 text-muted text-center">No variants found</div>';
                        searchDropdown.classList.remove('d-none');
                    }
                })
                .catch(err => {
                    searchDropdown.innerHTML = '<div class="p-3 text-danger text-center">Search error</div>';
                    searchDropdown.classList.remove('d-none');
                });
        }, 300);
    });
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
            searchDropdown.classList.add('d-none');
        }
    });
    
    function getPenetranceBadge(value) {
        if (value < 20) return 'bg-success';
        if (value < 40) return 'bg-info';
        if (value < 60) return 'bg-warning text-dark';
        if (value < 80) return 'bg-danger';
        return 'bg-danger';
    }
});
</script>
{% endblock %}

<section id="get-started" class="py-4">
    <h2 class="h4 fw-semibold mb-4">Jump straight to a dataset</h2>
    <div class="row g-4">
        <div class="col-md-6 col-lg-3">
            <a class="text-decoration-none" href="{% url 'kcnq1:main' %}">
                <div class="card h-100 border-0 shadow-sm hover-shadow">
                    <div class="card-body">
                        <h3 class="card-title h5"><i>KCNQ1</i></h3>
                        <p class="card-text text-muted mb-0">Long QT type 1 variants with curated penetrance, functional
                            assays, and structural annotations.</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-6 col-lg-3">
            <a class="text-decoration-none" href="{% url 'kcnh2:main' %}">
                <div class="card h-100 border-0 shadow-sm hover-shadow">
                    <div class="card-body">
                        <h3 class="card-title h5"><i>KCNH2</i></h3>
                        <p class="card-text text-muted mb-0">Comprehensive view of LQT2 and SQT1 evidence, including
                            patch-clamp electrophysiology summaries.</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-6 col-lg-3">
            <a class="text-decoration-none" href="{% url 'scn5a:main' %}">
                <div class="card h-100 border-0 shadow-sm hover-shadow">
                    <div class="card-body">
                        <h3 class="card-title h5"><i>SCN5A</i></h3>
                        <p class="card-text text-muted mb-0">Variant browser highlighting Brugada syndrome and LQT3
                            penetrance estimates alongside carrier counts.</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-6 col-lg-3">
            <a class="text-decoration-none" href="{% url 'ryr2:main' %}">
                <div class="card h-100 border-0 shadow-sm hover-shadow">
                    <div class="card-body">
                        <h3 class="card-title h5"><i>RYR2</i></h3>
                        <p class="card-text text-muted mb-0">Curated carriers and literature supporting catecholaminergic
                            polymorphic ventricular tachycardia research.</p>
                    </div>
                </div>
            </a>
        </div>
    </div>
</section>

<section class="py-5">
    <div class="row g-4 align-items-center">
        <div class="col-lg-6">
            <h2 class="h3 fw-semibold">Why this browser matters</h2>
            <p class="text-muted">Genome sequencing is now routine, yet interpreting rare variants remains challenging.
                The Variant Browser compiles published carrier cohorts, <i>in vitro</i> functional data, structural context,
                and <i>in silico</i> predictors to deliver transparent, quantitative penetrance estimates.</p>
            <ul class="list-unstyled text-muted mb-0">
                <li class="mb-2"><span class="badge bg-secondary-subtle text-secondary-emphasis me-2">Curated evidence</span>
                    Harmonised data across literature, clinics, and population resources.</li>
                <li class="mb-2"><span class="badge bg-secondary-subtle text-secondary-emphasis me-2">Interactive tools</span>
                    Filterable tables, downloadable CSVs, and chart-based summaries.</li>
                <li><span class="badge bg-secondary-subtle text-secondary-emphasis me-2">Clinical context</span>
                    Penetrance estimates to support variant reclassification and counselling.</li>
            </ul>
        </div>
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h3 class="h5 fw-semibold">Publications</h3>
                    <p class="text-muted">Our analyses are described in:</p>
                    <ul class="list-unstyled small mb-0">
                        <li class="mb-2"><a href="https://pubmed.ncbi.nlm.nih.gov/32569262/" class="link-primary" target="_blank" rel="noopener">Kroncke et al. 2020, <em>PLOS Genetics</em></a></li>
                        <li class="mb-2"><a href="https://pubmed.ncbi.nlm.nih.gov/34309407/" class="link-primary" target="_blank" rel="noopener">Kozek et al. 2021, <em>Circulation: Genomic and Precision Medicine</em></a></li>
                        <li><a href="https://pubmed.ncbi.nlm.nih.gov/36496179/" class="link-primary" target="_blank" rel="noopener">O’Neill et al. 2023, <em>Genetics in Medicine</em></a></li>
                        <li><a href="https://pubmed.ncbi.nlm.nih.gov/39315434/" target="_blank" rel="noopener">O’Neill et al. 2024, <em>Circulation</em></a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="py-5">
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <h3 class="h5 fw-semibold">Stay connected</h3>
                    <p class="text-muted">The Kroncke lab maintains the Variant Browser and welcomes collaborations,
                        feedback, and new data contributions.</p>
                    <ul class="list-unstyled small mb-0">
                        <li>Email: <a href="mailto:brett.m.kroncke.1@vumc.org">brett.m.kroncke.1@vumc.org</a></li>
                        <li>Lab website: <a href="https://kroncke-lab.github.io/index.html" target="_blank" rel="noopener">https://kroncke-lab.github.io</a></li>
                        <li>Source: <a href="https://github.com/kroncke-lab/Variant_Browser" target="_blank" rel="noopener">GitHub repository</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <h3 class="h5 fw-semibold">Need the raw data?</h3>
                    <p class="text-muted">Each table includes export options. For larger integrations, please reach out so
                        we can coordinate access to updated datasets and metadata schemas.</p>
                    <a class="btn btn-outline-primary" href="{% url 'penetrance_estimate' %}">Review the penetrance protocol</a>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
