{% extends "base.html" %}
{% load static %}

{% block extra_css %}
    {{ block.super }}
    <style>
    .lds-dual-ring {
      display: flex;
        justify-content: center;
        align-items: center;
    }
    .lds-dual-ring:after {
      content: " ";
      display: block;
      width: 64px;
      height: 64px;
      margin: 28px;
      border-radius: 50%;
      border: 6px solid #78cbf1;
      border-color: #646464 transparent #646464 transparent;
      animation: lds-dual-ring 1.2s linear infinite;
    }
    @keyframes lds-dual-ring {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    /* Distribution Charts Section */
    .distribution-section {
        background-color: #f5f6f8;
        padding: 40px 30px;
        margin-top: 40px;
        border-radius: 12px;
    }
    .section-header {
        margin-bottom: 28px;
    }
    .section-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 4px;
    }
    .section-subtitle {
        font-size: 0.875rem;
        color: #6b7280;
        margin: 0;
    }
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
    }
    @media (max-width: 992px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }
    .chart-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        padding: 24px;
    }
    .chart-card-header {
        margin-bottom: 16px;
    }
    .chart-card-header h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 4px 0;
    }
    .chart-card-header p {
        font-size: 0.8125rem;
        color: #9ca3af;
        margin: 0;
    }
    .chart-container {
        min-height: 280px;
    }
    </style>
    <!-- DataTables 1.x Core CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
    <!-- Buttons Extension CSS (v2.x for DT1) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
    <!-- Select Extension CSS (v1.x for DT1) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.dataTables.min.css">
    <!-- SearchBuilder Extension CSS (v1.x for DT1) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/searchbuilder/1.6.0/css/searchBuilder.dataTables.min.css">
    <!-- SearchPanes Extension CSS (v2.x for DT1) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/searchpanes/2.2.0/css/searchPanes.dataTables.min.css">
    <!-- Scroller Extension CSS (virtual scrolling) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/scroller/2.3.0/css/scroller.dataTables.min.css">
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <!-- DataTables 1.x Core JS -->
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <!-- JSZip (required for Excel export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- pdfmake (required for PDF export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <!-- Buttons Extension JS (v2.x for DT1) -->
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
    <!-- Select Extension JS (v1.x for DT1) -->
    <script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
    <!-- SearchBuilder Extension JS (v1.x for DT1) -->
    <script src="https://cdn.datatables.net/searchbuilder/1.6.0/js/dataTables.searchBuilder.min.js"></script>
    <!-- SearchPanes Extension JS (v2.x for DT1) -->
    <script src="https://cdn.datatables.net/searchpanes/2.2.0/js/dataTables.searchPanes.min.js"></script>
    <!-- Responsive Extension JS -->
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <!-- Scroller Extension JS (virtual scrolling for large datasets) -->
    <script src="https://cdn.datatables.net/scroller/2.3.0/js/dataTables.scroller.min.js"></script>
    <!-- Plotly -->
    <script src='https://cdn.plot.ly/plotly-2.27.1.min.js'></script>
    <!-- Shared Chart Theme -->
    <script type="text/javascript" src="{% static 'js/chart_theme.js' %}"></script>
    <!-- Custom KCNH2 JS -->
    <script type="text/javascript" src="{% static 'js/var_table_kcnh2.js' %}"></script>
    <!-- Initialize Bootstrap tooltips -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function(el) {
                return new bootstrap.Tooltip(el);
            });
        });
    </script>
{% endblock %}

{% block page_content %}

<div align="center" class="text-center" style="margin-top: 30px">
    <h1>
        <p> <i>KCNH2</i> Variant Browser </p>
    </h1>
</div>
<div>
    <p>
        Below is a comprehensive list of variants found in <i>KCNH2</i> affected or unaffected with the disease most
        commonly associated with variants in <i>KCNH2</i>: long QT type 2 (LQT2; OMIM: 613688). Coding variants are
        referenced to isoform "A" (Q12809-1, transcript ENST00000262186.10) to match convention.
        Our analysis is primarily for missense and in-frame insertion/deletion
        variants; however, some nonsense variants are included. We do not include synonymous variants.
        'LQT2' is the number of heterozygotes diagnosed with LQT2; 'Unaffected' is the number of heterozygotes
        unaffected with disease, including those found in the genome aggregation database (gnomAD). Multiplexed assay of variant effect (MAVE) data
            demonstrate concentration of the potassium channel at the cell surface, done in very high throughput, referenced to
WT (100%), PMID: 39315434. Click variant link
        for more details. Below are histogram plots for LQT2 affected carriers, unaffected carriers, and estimated LQT2
        penetrance. Use the 'Search Builder' and 'Search Panes' to select subsets of variants based on properties you
        are interested in (results will update the histogram plots below).
    </p>
</div>
<!-- Quick Stats Banner - updates with filters -->
<div id="quick-stats" class="my-3 p-3 bg-light rounded-3 text-center" style="display:none;">
    <div class="d-flex flex-wrap gap-3 justify-content-center align-items-center">
        <span class="text-muted">Loading statistics...</span>
    </div>
</div>
    <div class="lds-dual-ring" align="center" ></div>
<table id="example" class="table table-striped table-bordered" style="display:none">
    <thead>
    <tr>
        <th>Ch.7</th>
        <th>HGVSc</th>
        <th>Variant</th>
        <th>Residue Number</th>
        <th data-bs-toggle="tooltip" data-bs-placement="top" title="Number of heterozygous carriers diagnosed with Long QT Syndrome type 2">LQT2</th>
        <th data-bs-toggle="tooltip" data-bs-placement="top" title="Heterozygous carriers from literature and clinical cohorts (excluding gnomAD)">Lit/Cohort</th>
        <th data-bs-toggle="tooltip" data-bs-placement="top" title="Heterozygous carriers from gnomAD population database (assumed unaffected given LQT2 rarity)">gnomAD</th>
        <th data-bs-toggle="tooltip" data-bs-placement="top" title="Cell surface trafficking relative to wild-type (100%). Values <50% suggest moderate functional impact; <30% suggests strong impact. PMID: 39315434">MAVE Function</th>
        <th data-bs-toggle="tooltip" data-bs-placement="top" title="Structural region within the KCNH2 protein (e.g., Pore, Transmembrane, Cytoplasmic)">Location</th>
        <th data-bs-toggle="tooltip" data-bs-placement="top" title="Bayesian posterior mean probability of LQT2 diagnosis given heterozygosity. Combines variant features (prior) with observed carrier data.">LQT2 Penetrance(%)</th>
    </tr>
    </thead>
    <tbody>
    <!-- Data loaded via AJAX from /kcnh2/api/variants/ -->
    </tbody>
</table>
<!-- Distribution Charts Section -->
<div class="distribution-section">
    <div class="section-header">
        <h2>Distribution Charts</h2>
        <p class="section-subtitle">Charts update automatically when you filter the table above</p>
    </div>

    <div class="charts-grid">
        <!-- LQT2 Carrier Distribution -->
        <div class="chart-card">
            <div class="chart-card-header">
                <h3>LQT2 Carrier Distribution</h3>
                <p>Number of affected carriers per variant</p>
            </div>
            <div id="myDiv" class="chart-container"></div>
        </div>

        <!-- Total Carrier Distribution -->
        <div class="chart-card">
            <div class="chart-card-header">
                <h3>Total Carrier Distribution</h3>
                <p>Unaffected carriers including gnomAD (log scale, capped at 300)</p>
            </div>
            <div id="myDiv2" class="chart-container"></div>
        </div>

        <!-- LQT2 Penetrance Distribution -->
        <div class="chart-card">
            <div class="chart-card-header">
                <h3>LQT2 Penetrance Distribution</h3>
                <p>Estimated penetrance from 0% to 100%</p>
            </div>
            <div id="myDiv3" class="chart-container"></div>
        </div>
    </div>
</div>
{% endblock %}
