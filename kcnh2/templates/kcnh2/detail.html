{% extends "base.html" %}
{% load static %}
{% block title %}<i>KCNH2</i> {{ variant.var }} · Variant Detail{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'vendor/datatables/css/jquery.dataTables.min.css' %}">
<style>
    .stat-card {
        border-radius: 1rem;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 600;
    }

    section + section {
        margin-top: 3rem;
    }
</style>
{% endblock %}
{% block page_content %}
<section class="py-4">
    <div class="text-center mb-4">
        <h1 class="display-6 fw-semibold"><i>KCNH2</i> Variant {{ variant.var }}</h1>
        <p class="text-muted mx-auto" style="max-width: 60rem;">
            Summary of observed carriers, functional annotations, and structural context for <i>KCNH2</i> {{ variant.var }}.
            Data combine curated literature, international cohorts, and gnomAD observations.
        </p>
    </div>
    <div class="row g-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm stat-card h-100">
                <div class="card-body text-center">
                    <p class="text-muted text-uppercase small mb-1">Estimated LQT2 penetrance</p>
                    <p class="stat-value text-primary">{% widthratio variant.p_mean_w 1 100 %}%</p>
                    <p class="small text-muted mb-0">{{ alpha_lqt2 }}/{{ tot_with_prior }} effective observations</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm stat-card h-100">
                <div class="card-body text-center">
                    <p class="text-muted text-uppercase small mb-1">Total carriers</p>
                    <p class="stat-value">{{ variant.total_carriers }}</p>
                    <p class="small text-muted mb-0">{{ variant.lqt2 }} LQT2 · {{ variant.unaff }} unaffected</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm stat-card h-100">
                <div class="card-body text-center">
                    <p class="text-muted text-uppercase small mb-1">Functional studies</p>
                    <p class="stat-value">{{ recs_funcs|length }}</p>
                    <p class="small text-muted mb-0">Publications with functional data</p>
                </div>
            </div>
        </div>
    </div>
    <div class="alert alert-info mt-4" role="note">
        {% if variant.gnomad > 0 %}
            {{ variant.var }} is present in {{ variant.gnomad }} alleles in gnomAD.
        {% else %}
            {{ variant.var }} has not been reported in gnomAD.
        {% endif %}
        This residue resides in a {{ variant.structure }} region for LQT2.
    </div>
    {% if mave_score != None and mave_score != "NA" %}
        <p class="text-muted small">We have tested the trafficking efficiency of this variant: {{ mave_score|floatformat:0 }}% of WT with a standard error of {{ mave_score_SE|floatformat:0 }}%. In our analysis we used SE &lt; 20% as 'high quality'. Approximately below 50% of WT is considered PS3 moderate and below 30% is PS3 strong.</p>
    {% endif %}
    {% if alpha != "NA" %}
        <p class="text-muted small">Variant features alone are equivalent to phenotyping {{ alpha }} individuals with LQT2 and {{ beta }} unaffected individuals.</p>
    {% endif %}
</section>

<section aria-labelledby="in-silico-heading">
    <div class="d-flex align-items-center gap-3 mb-3">
        <h2 id="in-silico-heading" class="h4 fw-semibold mb-0"><em>In silico</em> predictors</h2>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle mb-2">
            <caption class="text-muted">Variant-level computational predictors.</caption>
            <thead class="table-light">
            <tr>
                <th scope="col">PROVEAN</th>
                <th scope="col">PolyPhen-2</th>
                <th scope="col">BLAST-PSSM</th>
                <th scope="col">REVEL</th>
                <th scope="col">Penetrance Density LQT2 (%)</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>{{ variant.provean_score }}</td>
                <td>{{ variant.pph2_prob }}</td>
                <td>{{ variant.blast_pssm }}</td>
                <td>{{ variant.revel_score }}</td>
                <td>{% widthratio variant.lqt2_dist 1 100 %}</td>
            </tr>
            </tbody>
        </table>
    </div>
    <p class="text-muted small">PROVEAN scores below -2 suggest deleterious impact. REVEL scores above 0.5–0.75 are often interpreted as likely pathogenic. PolyPhen-2 scores above 0.85 are typically pathogenic. BLAST-PSSM reflects evolutionary conservation; more negative values indicate rarer substitutions. Penetrance density summarises neighbouring residue risk (<a href="https://pubmed.ncbi.nlm.nih.gov/30828412/" target="_blank" rel="noopener">Kroncke et al. 2019</a>).</p>
</section>

<section aria-labelledby="carrier-heading">
    <div class="d-flex align-items-center gap-3 mb-3">
        <h2 id="carrier-heading" class="h4 fw-semibold mb-0">Reported carrier data</h2>
    </div>
    <div class="table-responsive">
        <table id="clinrecs" class="table table-striped table-bordered align-middle" style="width:100%">
            <caption class="text-muted">Observed carriers by publication or cohort.</caption>
            <thead class="table-light">
            <tr>
                <th scope="col">Source</th>
                <th scope="col">Year</th>
                <th scope="col">Carriers</th>
                <th scope="col">Unaffected</th>
                <th scope="col">LQT2</th>
                <th scope="col">Other Disease</th>
            </tr>
            </thead>
            <tbody>
            {% if clin_papers > 0 %}
                {% for p in recs_clin %}
                    <tr>
                        <td>
                            {% if p.pmid != "Italy Cohort" and p.pmid != "Japan Cohort" and p.pmid != "Paris Cohort" %}
                                <a href="https://pubmed.ncbi.nlm.nih.gov/{{ p.pmid }}" target="_blank" rel="noopener">{{ p.pmid }}</a>
                            {% else %}
                                {{ p.pmid }}
                            {% endif %}
                        </td>
                        <td>{{ p.year }}</td>
                        <td>{{ p.car }}</td>
                        <td>{{ p.unaffected }}</td>
                        <td>{{ p.lqt }}</td>
                        <td>{{ p.other_diag }}</td>
                    </tr>
                {% endfor %}
            {% endif %}
            <tr>
                <td>Literature, cohort, and gnomAD</td>
                <td>–</td>
                <td>{{ total_carriers }}</td>
                <td>{{ variant.unaff }}</td>
                <td>{{ variant.lqt2 }}</td>
                <td>–</td>
            </tr>
            <tr>
                <td>Variant features alone</td>
                <td>–</td>
                <td>10</td>
                <td>{{ beta }}</td>
                <td>{{ alpha }}</td>
                <td>–</td>
            </tr>
            </tbody>
        </table>
    </div>
    <p class="text-muted small">Totals may differ from individual publications due to duplicate patients removed during curation.</p>
</section>

{% if func_papers > 0 %}
<section aria-labelledby="functional-heading">
    <div class="d-flex align-items-center gap-3 mb-3">
        <h2 id="functional-heading" class="h4 fw-semibold">Functional data</h2>
    </div>
    <p class="text-muted small">Functional assay results from published electrophysiology studies. Steady state (S.S.) and peak tail current are relative % to wildtype (100% being no different from wildtype). V<sub>1/2</sub> activation and inactivation are the voltages at which half of the maximal current is reached, in mV. Recovery from inactivation and deactivation time are ratios of characteristic time constants with wildtype. HM indicates homomeric channels, HT indicates heteromeric channels.</p>

    <h3 class="h6 fw-semibold mt-4 mb-2">Homomeric channel data</h3>
    <div class="table-responsive">
        <table id="funcrecshm" class="table table-striped table-bordered align-middle" style="width:100%">
            <caption class="text-muted">Published electrophysiology measurements (homomeric).</caption>
            <thead class="table-light">
            <tr>
                <th scope="col">PubMed ID</th>
                <th scope="col">Cell Type</th>
                <th scope="col">S.S Peak (%WT)</th>
                <th scope="col">Peak Tail I<sub>Kr</sub> (%WT)</th>
                <th scope="col">V<sub>1/2</sub> Act.</th>
                <th scope="col">V<sub>1/2</sub> Inact.</th>
                <th scope="col">Recov. Inact.</th>
                <th scope="col">Deactivation (%WT)</th>
            </tr>
            </thead>
            <tbody>
            {% for p in recs_funcs %}
                <tr>
                    <td><a href="https://pubmed.ncbi.nlm.nih.gov/{{ p.pmid }}" target="_blank" rel="noopener">{{ p.pmid }}</a></td>
                    <td>{{ p.cell_type }}</td>
                    <td>{% widthratio p.hm_ss 1 100 %}</td>
                    <td>{% widthratio p.hm_peak_tail 1 100 %}</td>
                    <td>{{ p.hm_act }}</td>
                    <td>{{ p.hm_inact }}</td>
                    <td>{{ p.hm_recov_inact }}</td>
                    <td>{{ p.hm_tau_deact_fast }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <h3 class="h6 fw-semibold mt-4 mb-2">Heteromeric channel data</h3>
    <div class="table-responsive">
        <table id="funcrecsht" class="table table-striped table-bordered align-middle" style="width:100%">
            <caption class="text-muted">Published electrophysiology measurements (heteromeric).</caption>
            <thead class="table-light">
            <tr>
                <th scope="col">PubMed ID</th>
                <th scope="col">Cell Type</th>
                <th scope="col">S.S Peak (%WT)</th>
                <th scope="col">Peak Tail I<sub>Kr</sub> (%WT)</th>
                <th scope="col">V<sub>1/2</sub> Act.</th>
                <th scope="col">V<sub>1/2</sub> Inact.</th>
                <th scope="col">Deactivation (%WT)</th>
            </tr>
            </thead>
            <tbody>
            {% for p in recs_funcs %}
                <tr>
                    <td><a href="https://pubmed.ncbi.nlm.nih.gov/{{ p.pmid }}" target="_blank" rel="noopener">{{ p.pmid }}</a></td>
                    <td>{{ p.cell_type }}</td>
                    <td>{% widthratio p.ht_ss 1 100 %}</td>
                    <td>{% widthratio p.ht_peak_tail 1 100 %}</td>
                    <td>{{ p.ht_act }}</td>
                    <td>{{ p.ht_inact }}</td>
                    <td>{{ p.ht_deact }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

{% if var_type %}
<section aria-labelledby="neighbor-heading">
    <div class="d-flex align-items-center gap-3 mb-3">
        <h2 id="neighbor-heading" class="h4 fw-semibold">Nearby variants</h2>
    </div>
    <p class="text-muted small">Neighbouring residues within 15 Ångström provide structural context. Variants listed in the right-most column have been observed clinically or in gnomAD. Note that some residues appear multiple times at different distances since the functional K<sub>V</sub>11.1 channel (protein product of <i>KCNH2</i>/hERG) is a homotetramer and occasionally the same residue from multiple subunits is present within the 15Å window.</p>
    <div class="table-responsive">
        <table id="distrecs" class="table table-striped table-bordered align-middle" style="width:100%">
            <caption class="text-muted">Previously observed variants near {{ variant.var }}.</caption>
            <thead class="table-light">
            <tr>
                <th scope="col">Neighbour residue</th>
                <th scope="col">Distance (Å)</th>
                <th scope="col">Observed variants</th>
            </tr>
            </thead>
            <tbody>
            {% for p in recs_dists %}
                <tr>
                    <td>{{ p.neighbor }}</td>
                    <td>{% widthratio p.distance 1 1 %}</td>
                    <td>
                        {% for r in recs_vars %}
                            {% if r.resnum == p.neighbor %}
                                <a href="{% url 'kcnh2:detail' r.hgvsc %}">{{ r.var }}</a>{% if not forloop.last %}, {% endif %}
                            {% endif %}
                        {% endfor %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}
{% endblock %}
{% block extra_js %}
<script src="{% static 'vendor/datatables/js/jquery.dataTables.min.js' %}"></script>
<script>
    const tableOptions = {
        paging: false,
        searching: false,
        info: false,
        ordering: true,
        scrollY: 320,
        scrollCollapse: true
    };

    $(function () {
        $('#clinrecs').DataTable(tableOptions);
        ['#funcrecshm', '#funcrecsht', '#distrecs'].forEach((selector) => {
            const table = $(selector);
            if (table.length) {
                table.DataTable(tableOptions);
            }
        });
    });
</script>
{% endblock %}
